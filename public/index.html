<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; font-src 'self' data:; form-action 'none'; base-uri 'self'; frame-ancestors 'none';">
<title>AI Quota Monitor</title>
<link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="container">
  <h1>⚡ AI Quota <span>Monitor</span><small class="app-version" id="app-version"></small></h1>

  <!-- Dashboard -->
  <div id="dashboard"></div>

  <!-- Controls -->
  <div class="controls">
    <button id="btn-start">▶ 開始</button>
    <button id="btn-poll">⟳ 今すぐ取得</button>
    <div class="spacer"></div>
    <div class="poll-ring-wrap" id="poll-ring"></div>
    <span class="status" id="poll-status"></span>
  </div>

  <!-- Token Setup -->
  <details class="setup" id="setup">
    <summary>🔑 トークン設定</summary>

    <div class="field account-group">
      <label>Claude Code アカウント (名前 + OAuth Token)</label>
      <div class="account-list" id="claude-accounts"></div>
      <button class="btn-mini btn-add" id="btn-add-claude" type="button">+ Claude を追加</button>
      <div class="help">
        <div class="help-title">取得方法:</div>
        <div class="cmd-list">
          <div class="cmd-item">
            <span class="cmd-os">macOS</span>
            <input class="cmd-code" type="text" readonly value="security find-generic-password -s &quot;Claude Code-credentials&quot; -w | python3 -c &quot;import sys,json; print(json.loads(sys.stdin.read())['claudeAiOauth']['accessToken'])&quot;">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
          <div class="cmd-item">
            <span class="cmd-os">Linux</span>
            <input class="cmd-code" type="text" readonly value="cat ~/.claude/.credentials.json | jq -r '.claudeAiOauth.accessToken'">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
          <div class="cmd-item">
            <span class="cmd-os">Windows</span>
            <input class="cmd-code" type="text" readonly value="(Get-Content &quot;$env:USERPROFILE\.claude\.credentials.json&quot; -Raw | ConvertFrom-Json).claudeAiOauth.accessToken">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
        </div>
      </div>
    </div>

    <div class="field account-group">
      <label>Codex アカウント (名前 + Access Token)</label>
      <div class="account-list" id="codex-accounts"></div>
      <button class="btn-mini btn-add" id="btn-add-codex" type="button">+ Codex を追加</button>
      <div class="help">
        <div class="help-title">取得方法:</div>
        <div class="cmd-list">
          <div class="cmd-item">
            <span class="cmd-os">Linux<br>macOS</span>
            <input class="cmd-code" type="text" readonly value="cat ~/.codex/auth.json | jq -r '.tokens.access_token'">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
          <div class="cmd-item">
            <span class="cmd-os">macOS<br>(Keychain)</span>
            <input class="cmd-code" type="text" readonly value="security find-generic-password -s &quot;Codex Auth&quot; -w | jq -r '.tokens.access_token'">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
          <div class="cmd-item">
            <span class="cmd-os">Windows</span>
            <input class="cmd-code" type="text" readonly value="(Get-Content &quot;$env:USERPROFILE\.codex\auth.json&quot; -Raw | ConvertFrom-Json).tokens.access_token">
            <button class="cmd-copy" type="button" title="コピー">⧉</button>
          </div>
        </div>
      </div>
    </div>

    <div class="field">
      <label>ポーリング間隔 (秒)</label>
      <div class="row">
        <input class="input-max-100" type="number" id="poll-interval" value="120" min="30" max="600">
      </div>
    </div>
  </details>

  <!-- Notification Settings -->
  <details class="setup" id="notify-setup">
    <summary>🔔 通知設定</summary>
    <div class="field">
      <label class="check-label"><input type="checkbox" id="notify-critical" checked> クォータが critical / exhausted に悪化した時</label>
    </div>
    <div class="field">
      <label class="check-label"><input type="checkbox" id="notify-recovery" checked> クォータが回復した時 (critical/exhausted → ok)</label>
    </div>
    <div class="field">
      <label class="check-label"><input type="checkbox" id="notify-warning"> クォータが warning に悪化した時</label>
    </div>
    <div class="field threshold-row">
      <label>閾値 (%)</label>
      <div class="row">
        <span class="threshold-label">Warning</span>
        <input class="input-max-70" type="number" id="threshold-warning" value="75" min="1" max="99">
        <span class="threshold-label">Critical</span>
        <input class="input-max-70" type="number" id="threshold-critical" value="90" min="1" max="99">
        <span class="threshold-label threshold-fixed">Exhausted = 100%</span>
      </div>
    </div>
    <div class="field">
      <button class="btn-mini" id="btn-notify-test" type="button">テスト通知を送信</button>
    </div>
  </details>

  <!-- Raw responses for debugging -->
  <details class="raw" id="raw-section">
    <summary>🔍 生レスポンス (デバッグ用)</summary>
    <pre id="raw-data">まだ取得されていません</pre>
  </details>

  <!-- Log -->
  <details class="log-section">
    <summary>📋 ログ</summary>
    <div class="log-list" id="log-list"></div>
  </details>

  <p class="subtitle">トークンは OS キーチェーンに保存されます</p>
</div>

<script src="./ui-logic.js"></script>
<script src="./account-ui.js"></script>
<script src="./tauri-bridge.js"></script>
<script src="./app.js"></script>
</body>
</html>
